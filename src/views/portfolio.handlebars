<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
</head>
<body onload="getUserBalance()">



<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <h1 style="text-align: center">My Portfolio</h1>
            <table class="table" id="myTable">
                <thead>
                <tr>
                    <th scope="col">Team</th>
                    <th scope="col">Shares Owned</th>
                    <th scope="col">Price</th>
                    <th scope="col">Total</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
            <h3 id="balanceField" style="display:flex; padding: 5px; justify-content: center;align-items: center;"></h3>
            <div style="display:flex; padding: 10px; justify-content: center;align-items: center;">
                <button type="button" class="btn btn-dark" style="margin: 5px" onclick="toggleBuyForm()">Buy</button>
                <button type="button" class="btn btn-dark" style="margin: 5px" onclick="toggleSellForm()">Sell</button>
            </div>
            <!--buy form-->
            <form>
                <div class="form-group" id="buyForm" style="display: none;">
                    <label for="stock">Select a team:</label>
                    <select class="form-control" id="buyTeamDropdown" oninput="calculateBuyPrice()">
                        <option id="Montreal Canadiens">Montreal Canadiens</option>
                        <option id="Toronto Maple Leafs">Toronto Maple Leafs</option>
                        <option id="Boston Bruins">Boston Bruins</option>
                        <option id="Chicago Blackhawks">Chicago Blackhawks</option>
                        <option id="New York Rangers">New York Rangers</option>
                        <option id="Detroit Red Wings">Detroit Red Wings</option>
                    </select>
                    <label for="quantity">Quantity</label>
                    <input type="number" class="form-control" id="buyQuantity" placeholder="Enter quantity" oninput="calculateBuyPrice()">
                    <label for="price">Estimated Purchase Cost</label>
                    <input type="text" class="form-control" id="totalBuyCost" value="0.00" readonly>
                    <br>
                    <div style="text-align: center">
                        <button type="button" class="btn btn-dark">Confirm Order</button>
                    </div>
                    <br>
                </div>
            </form>
            <!--sell form-->
            <form>
                <div class="form-group" id="sellForm" style="display: none;">
                    <label for="stock">Select a team:</label>
                    <select class="form-control" id="sellTeamDropdown" oninput="calculateSellPrice()">
                        <option id="Montreal Canadiens">Montreal Canadiens</option>
                        <option id="Toronto Maple Leafs">Toronto Maple Leafs</option>
                        <option id="Boston Bruins">Boston Bruins</option>
                        <option id="Chicago Blackhawks">Chicago Blackhawks</option>
                        <option id="New York Rangers">New York Rangers</option>
                        <option id="Detroit Red Wings">Detroit Red Wings</option>
                    </select>
                    <label for="quantity">Quantity</label>
                    <input type="number" class="form-control" id="sellQuantity" placeholder="Enter quantity" oninput="calculateSellPrice()">
                    <label for="price">Estimated Sale</label>
                    <input type="text" class="form-control" id="totalSell" value="0.00" readonly>
                    <br>
                    <div style="text-align: center">
                        <button type="submit" class="btn btn-dark">Confirm Order</button>
                    </div>
                    <br>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    .col-md-6 {
        width: 50%;
    }
</style>

<script>
    let user_portfolio = new Map();
    let price_data = new Map();

    const baseUrl = 'https://z340b62ka1.execute-api.us-east-2.amazonaws.com/get_user_portfolio';
    const queryParams = {
        user_id: "{{user.sub}}"
    };

    const queryString = new URLSearchParams(queryParams).toString();
    const url = `${baseUrl}?${queryString}`;

    // Send the POST request
    fetch(url, {
        method: 'GET',
    }).then(response => response.text())
            .then(data => {
                console.log(JSON.parse(data))
                user_portfolio = new Map(Object.entries(JSON.parse(data)));
                generateTable()
            });

    async function getPrices() {

        const baseUrl = 'https://z340b62ka1.execute-api.us-east-2.amazonaws.com/get_prices';

        const response = await fetch(baseUrl, {
            method: 'GET',
        })
        return response.json();
    }

    async function generateTable() {

        price_data = await getPrices();
        console.log(price_data)
        var data = user_portfolio;

        // Get the table body element
        var tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";

        data.forEach(function(value, key) {
            var row = tableBody.insertRow();
            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            cell1.innerHTML = key;
            cell2.innerHTML = value;
            cell3.innerHTML = price_data[key];
            cell4.innerHTML = (parseFloat(price_data[key]) * parseFloat(value)).toString();
        });
    }

    async function getUserBalance() {
        const baseUrl = 'https://z340b62ka1.execute-api.us-east-2.amazonaws.com/get_user_balance';
        const queryParams = {
            user_id: "{{user.sub}}"
        };

        const queryString = new URLSearchParams(queryParams).toString();
        const url = `${baseUrl}?${queryString}`;

        fetch(url, {
            method: 'GET',
        }).then(response => response.text())
                .then(data => {
                    user_balance = JSON.parse(data)
                    document.getElementById("balanceField").innerHTML = "Balance: $" + parseFloat(user_balance);
                });

    }

    function toggleBuyForm() {
        var buyFormElement = document.getElementById("buyForm");
        var sellFormElement = document.getElementById("sellForm");
        if (buyFormElement.style.display === "none") {
            buyFormElement.style.display = "block";
        } else {
            buyFormElement.style.display = "none";
        }
        if (sellFormElement.style.display === "block") {
            sellFormElement.style.display = "none";
        } else {
            sellFormElement.style.display = "none";
        }
    }

    function toggleSellForm() {
        var buyFormElement = document.getElementById("buyForm");
        var sellFormElement = document.getElementById("sellForm");
        if (buyFormElement.style.display === "block") {
            buyFormElement.style.display = "none";
        } else {
            buyFormElement.style.display = "none";
        }
        if (sellFormElement.style.display === "block") {
            sellFormElement.style.display = "none";
        } else {
            sellFormElement.style.display = "block";
        }
    }

    function calculateBuyPrice() {
        var dropdown = document.getElementById("buyTeamDropdown");
        var dropdownValue = dropdown.value;

        var calculateBuyField = document.getElementById("totalBuyCost");
        calculateBuyField.value = price_data[dropdownValue] * document.getElementById("buyQuantity").value;
    }

    function calculateSellPrice() {
        var dropdown = document.getElementById("sellTeamDropdown");
        var dropdownValue = dropdown.value;

        var calculateBuyField = document.getElementById("totalSell");
        calculateBuyField.value = price_data[dropdownValue] * document.getElementById("sellQuantity").value;
    }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>

</body>
</html>